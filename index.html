<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#0f172a" />

    <!--
    ╔══════════════════════════════════════════════════════════════╗
    ║              WHITE LABEL CONFIG - EDIT BELOW                ║
    ║  Change these values for each new client deployment.        ║
    ╚══════════════════════════════════════════════════════════════╝
    -->
    <script>
      const WHITE_LABEL = {
        brandPart1:     "Carol",
        brandPart2:     "AI",

        pageTitle:      "Carol AI Assistant",

        taglineLeft:    "Need Help? Jay Beach | 901.289.0344",
        taglineRight:   "BUILT BY G1 GROUP | Portal Access",
        taglineLink:    "https://g1wins.com",
        copyright:      "\u00A9 OpenBroker Labs",

        disclaimer:     "This AI Tool is not a part of the above mentioned mortgage professional's Company, nothing provided by this tool is any type of commitment to lend or arrange any type of loan. AI can make mistakes. Check important info. Intended for information use only.",

        placeholder:    "Ask me anything about your mortgage...",

        accentColor:    "#a855f7",
        brandColor:     "#7c3aed",
      };

      document.title = WHITE_LABEL.pageTitle;
    </script>

    <title>Mortgage AI Assistant</title>

    <!-- Favicon: purple circle -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%237c3aed'/></svg>" />

    <style>
      /* ═══════════════════════════════════════════════════════════
         DESIGN TOKENS — Clean Slate + Purple Accent
         ═══════════════════════════════════════════════════════════ */
      :root {
        /* Slate palette */
        --slate-50:  #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-300: #cbd5e1;
        --slate-400: #94a3b8;
        --slate-500: #64748b;
        --slate-600: #475569;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --slate-900: #0f172a;

        /* Purple accent */
        --purple-50:  #faf5ff;
        --purple-100: #f3e8ff;
        --purple-200: #e9d5ff;
        --purple-300: #d8b4fe;
        --purple-400: #c084fc;
        --purple-500: #a855f7;
        --purple-600: #9333ea;
        --purple-700: #7c3aed;
        --purple-800: #6d28d9;
        --purple-900: #581c87;

        /* Semantic tokens */
        --bg-app:        var(--slate-50);
        --bg-surface:    #ffffff;
        --bg-surface-alt: var(--slate-100);
        --bg-user-msg:   var(--purple-700);
        --bg-ai-msg:     #ffffff;
        --text-primary:  var(--slate-900);
        --text-secondary: var(--slate-500);
        --text-tertiary: var(--slate-400);
        --text-inverse:  #ffffff;
        --border-light:  var(--slate-200);
        --border-focus:  var(--purple-500);
        --accent:        var(--purple-600);
        --accent-soft:   var(--purple-100);
        --success:       #10b981;

        /* Radii */
        --r-sm: 8px;
        --r-md: 16px;
        --r-lg: 24px;
        --r-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        --shadow-input: 0 2px 8px rgba(0,0,0,0.06);

        /* Transition */
        --ease: cubic-bezier(0.4, 0, 0.2, 1);

        /* Safe areas */
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
      }

      /* ── Reset ── */
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      html, body {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 16px;
        color: var(--text-primary);
        background: var(--bg-app);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }

      /* ═══════════════════════════════════════════════════════════
         APP SHELL — Full-screen mobile layout
         ═══════════════════════════════════════════════════════════ */
      .app {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        height: 100vh;
        width: 100%;
        max-width: 100%;
        position: relative;
        background: var(--bg-app);
      }

      /* ── Top Bar (accent strip) ── */
      .top-accent {
        height: 3px;
        background: linear-gradient(90deg, var(--purple-600), var(--purple-400), var(--purple-600));
        flex-shrink: 0;
      }

      /* ── Header ── */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        padding-top: calc(12px + var(--safe-top));
        background: var(--bg-surface);
        border-bottom: 1px solid var(--border-light);
        flex-shrink: 0;
        min-height: 56px;
        z-index: 10;
      }

      .header-brand {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }

      .header-brand .name {
        font-size: 20px;
        font-weight: 700;
        color: var(--purple-700);
        letter-spacing: -0.3px;
      }

      .header-brand .suffix {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-tertiary);
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .header-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--success);
        font-weight: 500;
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--success);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* ── Messages Area ── */
      .messages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: contain;
        scroll-behavior: smooth;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .messages::-webkit-scrollbar { width: 4px; }
      .messages::-webkit-scrollbar-track { background: transparent; }
      .messages::-webkit-scrollbar-thumb {
        background: var(--slate-300);
        border-radius: 4px;
      }

      /* ── Welcome / Centered State ── */
      .app.centered .header { display: none; }
      .app.centered .messages { display: none; }
      .app.centered .footer { display: none; }

      .app.centered .input-zone {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 32px);
        max-width: 640px;
      }

      .welcome-hero {
        display: none;
      }

      .app.centered .welcome-hero {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        text-align: center;
      }

      .welcome-logo {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--purple-600), var(--purple-500));
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
      }

      .welcome-logo svg {
        width: 28px;
        height: 28px;
        color: white;
      }

      .welcome-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 6px;
        letter-spacing: -0.3px;
      }

      .welcome-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        max-width: 280px;
      }

      /* Quick prompts */
      .quick-prompts {
        display: none;
      }

      .app.centered .quick-prompts {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-bottom: 20px;
        padding: 0 8px;
      }

      .quick-prompt {
        padding: 8px 14px;
        border: 1px solid var(--border-light);
        border-radius: var(--r-full);
        background: var(--bg-surface);
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s var(--ease);
        white-space: nowrap;
      }

      .quick-prompt:hover,
      .quick-prompt:active {
        border-color: var(--purple-300);
        color: var(--purple-700);
        background: var(--purple-50);
      }

      /* ═══════════════════════════════════════════════════════════
         MESSAGE BUBBLES — Claude.ai style
         ═══════════════════════════════════════════════════════════ */
      .msg {
        display: flex;
        flex-direction: column;
        animation: msgIn 0.3s var(--ease);
        max-width: 100%;
      }

      .msg.user {
        align-items: flex-end;
      }

      .msg.ai {
        align-items: flex-start;
      }

      @keyframes msgIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .bubble {
        max-width: 88%;
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .msg.user .bubble {
        background: var(--bg-user-msg);
        color: var(--text-inverse);
        border-bottom-right-radius: 6px;
      }

      .msg.ai .bubble {
        background: var(--bg-ai-msg);
        color: var(--text-primary);
        border-bottom-left-radius: 6px;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
      }

      .msg.ai .bubble.error {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }

      /* ── Rich text inside AI bubbles ── */
      .bubble h3, .bubble h4 {
        margin: 12px 0 6px;
        font-weight: 600;
      }
      .bubble h3:first-child, .bubble h4:first-child { margin-top: 0; }
      .bubble h3 { font-size: 15px; }
      .bubble h4 { font-size: 14px; }

      .bubble p { margin: 0 0 8px; }
      .bubble p:last-child { margin-bottom: 0; }

      .bubble ul, .bubble ol {
        margin: 6px 0;
        padding-left: 20px;
      }
      .bubble li { margin: 3px 0; }

      .bubble strong { font-weight: 600; }
      .bubble em { font-style: italic; }
      .bubble a { color: var(--purple-600); text-decoration: underline; }

      .bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 13px;
      }
      .bubble th, .bubble td {
        border: 1px solid var(--border-light);
        padding: 6px 10px;
        text-align: left;
      }
      .bubble th {
        background: var(--slate-50);
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-secondary);
      }
      .bubble tr:nth-child(even) td {
        background: var(--slate-50);
      }

      /* ── Message Actions (Copy / Share) ── */
      .msg-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        margin-top: 4px;
        padding-left: 4px;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-tertiary);
        cursor: pointer;
        border-radius: var(--r-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s var(--ease);
        position: relative;
      }

      .action-btn:active {
        transform: scale(0.9);
        background: var(--slate-100);
      }

      .action-btn:hover {
        color: var(--text-secondary);
        background: var(--slate-100);
      }

      .action-btn.copied {
        color: var(--success);
      }

      .action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* ── Thinking / Loading ── */
      .thinking {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        animation: msgIn 0.3s var(--ease);
      }

      .thinking-bubble {
        background: var(--bg-surface);
        border: 1px solid var(--border-light);
        border-radius: 20px;
        border-bottom-left-radius: 6px;
        padding: 14px 18px;
        max-width: 88%;
        box-shadow: var(--shadow-sm);
      }

      .thinking-stages {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .stage {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 10px;
        border-radius: var(--r-sm);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        opacity: 0;
        transform: translateX(-6px);
        animation: stageIn 0.25s var(--ease) forwards;
      }

      @keyframes stageIn {
        to { opacity: 1; transform: translateX(0); }
      }

      .stage.active {
        color: var(--purple-600);
        background: var(--purple-50);
      }

      .stage.done {
        color: var(--success);
        background: rgba(16, 185, 129, 0.06);
      }

      .stage-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid var(--purple-200);
        border-top-color: var(--purple-600);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      .stage-text { flex: 1; }
      .stage-time {
        font-size: 11px;
        color: var(--text-tertiary);
        font-variant-numeric: tabular-nums;
      }

      /* ═══════════════════════════════════════════════════════════
         INPUT ZONE — Bottom-anchored, Claude-style
         ═══════════════════════════════════════════════════════════ */
      .input-zone {
        flex-shrink: 0;
        padding: 0 12px 12px;
        padding-bottom: calc(12px + var(--safe-bottom));
        background: var(--bg-app);
        z-index: 10;
      }

      .app:not(.centered) .input-zone {
        border-top: 1px solid var(--border-light);
        background: var(--bg-surface);
      }

      .input-wrap {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        background: var(--bg-surface);
        border: 1.5px solid var(--border-light);
        border-radius: var(--r-lg);
        padding: 8px 8px 8px 16px;
        transition: border-color 0.2s var(--ease), box-shadow 0.2s var(--ease);
        box-shadow: var(--shadow-input);
      }

      .app.centered .input-wrap {
        box-shadow: var(--shadow-md);
      }

      .input-wrap:focus-within {
        border-color: var(--purple-400);
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.12), var(--shadow-input);
      }

      .input-field {
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        font-family: inherit;
        font-size: 16px;
        line-height: 1.5;
        color: var(--text-primary);
        min-height: 24px;
        max-height: 120px;
        padding: 6px 0;
        overflow-y: auto;
        -webkit-appearance: none;
      }

      .input-field::placeholder {
        color: var(--text-tertiary);
      }

      .send-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--slate-300);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s var(--ease);
      }

      .send-btn:not(:disabled) {
        background: var(--purple-600);
      }

      .send-btn:not(:disabled):active {
        transform: scale(0.92);
        background: var(--purple-700);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .send-btn svg {
        width: 18px;
        height: 18px;
      }

      /* ═══════════════════════════════════════════════════════════
         FOOTER — Tagline + Disclaimer
         ═══════════════════════════════════════════════════════════ */
      .footer {
        flex-shrink: 0;
        padding: 8px 16px calc(8px + var(--safe-bottom));
        background: var(--bg-surface);
        border-top: 1px solid var(--border-light);
      }

      .footer-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 4px 12px;
        margin-bottom: 4px;
      }

      .footer-contact {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 400;
      }

      .footer-contact .name {
        color: var(--text-primary);
        font-weight: 600;
      }

      .footer-link {
        font-size: 12px;
        color: var(--purple-600);
        text-decoration: none;
        font-weight: 500;
      }

      .footer-link:active { opacity: 0.7; }

      .footer-copy {
        font-size: 10px;
        color: var(--text-tertiary);
        margin-top: 2px;
      }

      .footer-disclaimer {
        font-size: 10px;
        color: var(--text-tertiary);
        line-height: 1.4;
        margin-top: 4px;
      }

      /* Centered state tagline (below input) */
      .centered-footer {
        display: none;
      }

      .app.centered .centered-footer {
        display: block;
        padding: 16px 4px 0;
        text-align: center;
      }

      .centered-footer .footer-contact {
        display: block;
        margin-bottom: 4px;
      }

      .centered-footer .footer-link {
        display: inline-block;
        margin-bottom: 6px;
      }

      .centered-footer .footer-copy {
        display: block;
        margin-bottom: 4px;
      }

      .centered-footer .footer-disclaimer {
        max-width: 400px;
        margin: 0 auto;
      }

      /* ═══════════════════════════════════════════════════════════
         TOAST NOTIFICATION
         ═══════════════════════════════════════════════════════════ */
      .toast {
        position: fixed;
        bottom: calc(100px + var(--safe-bottom));
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--slate-800);
        color: white;
        padding: 10px 20px;
        border-radius: var(--r-full);
        font-size: 13px;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s var(--ease);
        white-space: nowrap;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* ═══════════════════════════════════════════════════════════
         RESPONSIVE — Tablet+ enhancements
         ═══════════════════════════════════════════════════════════ */
      @media (min-width: 640px) {
        .app {
          max-width: 768px;
          margin: 0 auto;
          border-left: 1px solid var(--border-light);
          border-right: 1px solid var(--border-light);
        }

        .messages { padding: 20px 24px; gap: 6px; }
        .bubble { max-width: 80%; font-size: 15px; }

        .input-zone { padding: 0 16px 16px; }

        .header { padding: 14px 20px; padding-top: calc(14px + var(--safe-top)); }
      }

      @media (min-width: 1024px) {
        .bubble { max-width: 70%; }
      }

      /* ── Reduced motion ── */
      @media (prefers-reduced-motion: reduce) {
        .msg, .thinking, .stage { animation: none; }
        .messages { scroll-behavior: auto; }
        .spinner { animation: none; }
        .status-dot { animation: none; }
      }
    </style>
  </head>

  <body>
    <div class="app centered" id="app" role="main" aria-label="Mortgage Assistant Chat">

      <!-- Accent strip -->
      <div class="top-accent"></div>

      <!-- Header (visible once chat starts) -->
      <header class="header" id="header">
        <div class="header-brand">
          <span class="name" id="headerName"></span>
          <span class="suffix" id="headerSuffix"></span>
        </div>
        <div class="header-status">
          <span class="status-dot"></span>
          <span>Online</span>
        </div>
      </header>

      <!-- Messages -->
      <div class="messages" id="messages" role="log" aria-live="polite" aria-label="Chat messages"></div>

      <!-- Input Zone -->
      <div class="input-zone" id="inputZone">
        <!-- Welcome hero (centered state only) -->
        <div class="welcome-hero" id="welcomeHero">
          <div class="welcome-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="welcome-title" id="welcomeTitle"></div>
          <div class="welcome-subtitle">Your intelligent mortgage assistant. Ask me anything.</div>
        </div>

        <!-- Quick prompts -->
        <div class="quick-prompts" id="quickPrompts">
          <button class="quick-prompt" data-prompt="What rates are available today?">Today's rates</button>
          <button class="quick-prompt" data-prompt="How much can I afford?">Affordability</button>
          <button class="quick-prompt" data-prompt="What documents do I need?">Documents needed</button>
          <button class="quick-prompt" data-prompt="Explain refinancing options">Refinancing</button>
        </div>

        <!-- Input form -->
        <form class="input-form" id="inputForm" autocomplete="off">
          <div class="input-wrap">
            <label for="inputField" class="sr-only" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">Type your message</label>
            <textarea
              id="inputField"
              class="input-field"
              rows="1"
              placeholder=""
              aria-label="Message input"
              autocomplete="off"
              enterkeyhint="send"
            ></textarea>
            <button type="submit" class="send-btn" id="sendBtn" disabled aria-label="Send message">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </button>
          </div>
        </form>

        <!-- Centered footer (welcome state) -->
        <div class="centered-footer" id="centeredFooter">
          <div class="footer-contact" id="cfContact"></div>
          <a class="footer-link" id="cfLink" href="#" target="_blank" rel="noopener"></a>
          <div class="footer-copy" id="cfCopy"></div>
          <div class="footer-disclaimer" id="cfDisclaimer"></div>
        </div>
      </div>

      <!-- Footer (docked mode) -->
      <footer class="footer" id="footer">
        <div class="footer-row">
          <span class="footer-contact" id="ftContact"></span>
          <a class="footer-link" id="ftLink" href="#" target="_blank" rel="noopener"></a>
        </div>
        <div class="footer-copy" id="ftCopy"></div>
        <div class="footer-disclaimer" id="ftDisclaimer"></div>
      </footer>

      <!-- Toast notification -->
      <div class="toast" id="toast"></div>
    </div>

    <script>
      (function() {
        'use strict';

        const PROXY_URL = '/api/chat';

        // DOM refs
        const app = document.getElementById('app');
        const messages = document.getElementById('messages');
        const inputForm = document.getElementById('inputForm');
        const inputField = document.getElementById('inputField');
        const sendBtn = document.getElementById('sendBtn');
        const toastEl = document.getElementById('toast');

        let conversationHistory = [];
        let isProcessing = false;
        let chatStarted = false;

        // ── Thinking stages ──
        const stages = [
          { id: 'analyze',   text: 'Analyzing your question' },
          { id: 'search',    text: 'Searching program matrices' },
          { id: 'calculate', text: 'Calculating eligibility' },
          { id: 'format',    text: 'Preparing response' }
        ];
        let stageTimers = [];
        let stageStart = 0;
        let currentStage = 0;
        let elapsedTimer = null;

        // ═══════════════════════════════════════════════
        // HELPERS
        // ═══════════════════════════════════════════════

        const scrollToBottom = () => {
          requestAnimationFrame(() => {
            messages.scrollTop = messages.scrollHeight;
          });
        };

        const scrollToEl = (el) => {
          requestAnimationFrame(() => {
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        };

        const showToast = (text, duration = 2000) => {
          toastEl.textContent = text;
          toastEl.classList.add('show');
          setTimeout(() => toastEl.classList.remove('show'), duration);
        };

        const autoGrow = (el) => {
          el.style.height = 'auto';
          el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        };

        const dockInput = () => {
          if (!chatStarted) {
            chatStarted = true;
            app.classList.remove('centered');
          }
        };

        const updateSendBtn = () => {
          sendBtn.disabled = !inputField.value.trim() || isProcessing;
        };

        // ── Toast-based Copy ──
        const COPY_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
        const CHECK_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        const SHARE_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>';

        const copyText = (text, btn) => {
          navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = CHECK_ICON;
            btn.classList.add('copied');
            showToast('Copied to clipboard');
            setTimeout(() => { btn.innerHTML = COPY_ICON; btn.classList.remove('copied'); }, 1500);
          }).catch(() => {
            showToast('Failed to copy');
          });
        };

        const shareText = (text) => {
          if (navigator.share) {
            navigator.share({ text: text }).catch(() => {});
          } else {
            navigator.clipboard.writeText(text).then(() => {
              showToast('Copied to clipboard (share not supported)');
            }).catch(() => {
              showToast('Share not available');
            });
          }
        };

        // ═══════════════════════════════════════════════
        // MARKDOWN FORMATTING
        // ═══════════════════════════════════════════════

        const fmtCell = (t) => t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        const fmtTables = (t) => {
          const re = /\|(.+)\|\n\|[-|\s]+\|\n((?:\|.+\|\n?)+)/g;
          return t.replace(re, (_, hdr, body) => {
            const hs = hdr.split('|').map(h => h.trim()).filter(Boolean);
            const rs = body.trim().split('\n');
            let html = '<table><thead><tr>';
            hs.forEach(h => { html += '<th>' + fmtCell(h) + '</th>'; });
            html += '</tr></thead><tbody>';
            rs.forEach(r => {
              const cs = r.split('|').map(c => c.trim()).filter(Boolean);
              html += '<tr>';
              cs.forEach(c => { html += '<td>' + fmtCell(c) + '</td>'; });
              html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
          });
        };

        const formatResponse = (text) => {
          if (!text) return 'No response received.';
          let f = text;
          f = fmtTables(f);
          f = f.replace(/^### (.*$)/gm, '<h4>$1</h4>');
          f = f.replace(/^## (.*$)/gm, '<h3>$1</h3>');
          f = f.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          f = f.replace(/\*(.*?)\*/g, '<em>$1</em>');
          f = f.replace(/^- (.*$)/gm, '<li>$1</li>');
          f = f.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
          f = f.replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>');
          f = f.replace(/\n\n/g, '</p><p>');
          f = f.replace(/\n/g, '<br>');
          if (!f.startsWith('<')) f = '<p>' + f + '</p>';
          return f;
        };

        // ═══════════════════════════════════════════════
        // MESSAGE RENDERING
        // ═══════════════════════════════════════════════

        const addMessage = (role, text, isError) => {
          const thinkingEl = document.getElementById('thinkingIndicator');
          if (thinkingEl) {
            clearStages();
            thinkingEl.remove();
          }

          const row = document.createElement('div');
          row.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
          row.setAttribute('role', 'article');
          row.setAttribute('aria-label', role === 'user' ? 'You said' : 'Assistant said');

          const bubble = document.createElement('div');
          bubble.className = 'bubble' + (isError ? ' error' : '');

          if (role === 'assistant') {
            bubble.innerHTML = formatResponse(text);
          } else {
            bubble.textContent = text;
          }

          row.appendChild(bubble);

          // Copy + Share actions for AI messages
          if (role === 'assistant' && !isError) {
            const actions = document.createElement('div');
            actions.className = 'msg-actions';

            const cpBtn = document.createElement('button');
            cpBtn.className = 'action-btn';
            cpBtn.setAttribute('aria-label', 'Copy response');
            cpBtn.innerHTML = COPY_ICON;
            cpBtn.addEventListener('click', () => copyText(text, cpBtn));

            const shBtn = document.createElement('button');
            shBtn.className = 'action-btn';
            shBtn.setAttribute('aria-label', 'Share response');
            shBtn.innerHTML = SHARE_ICON;
            shBtn.addEventListener('click', () => shareText(text));

            actions.appendChild(cpBtn);
            actions.appendChild(shBtn);
            row.appendChild(actions);
          }

          messages.appendChild(row);

          if (role === 'user') {
            scrollToBottom();
          } else {
            scrollToEl(row);
          }
        };

        // ═══════════════════════════════════════════════
        // THINKING STAGES
        // ═══════════════════════════════════════════════

        const showThinking = () => {
          const row = document.createElement('div');
          row.className = 'thinking';
          row.id = 'thinkingIndicator';
          row.setAttribute('role', 'status');

          const bubble = document.createElement('div');
          bubble.className = 'thinking-bubble';

          let html = '<div class="thinking-stages">';
          stages.forEach(s => {
            html += '<div class="stage" id="stg-' + s.id + '" style="display:none;">' +
              '<div class="stage-icon"><div class="spinner"></div></div>' +
              '<span class="stage-text">' + s.text + '</span>' +
              '<span class="stage-time" id="tm-' + s.id + '"></span>' +
              '</div>';
          });
          html += '</div>';
          bubble.innerHTML = html;
          row.appendChild(bubble);
          messages.appendChild(row);
          scrollToBottom();
          startStages();
        };

        const startStages = () => {
          stageStart = Date.now();
          currentStage = 0;
          stageTimers = [];
          activate(0);
          stageTimers.push(setTimeout(() => { complete(0); activate(1); }, 600));
          stageTimers.push(setTimeout(() => { complete(1); activate(2); }, 1500));
          stageTimers.push(setTimeout(() => { complete(2); activate(3); }, 2800));
          elapsedTimer = setInterval(updateTime, 100);
        };

        const activate = (i) => {
          if (i >= stages.length) return;
          const el = document.getElementById('stg-' + stages[i].id);
          if (el) { el.style.display = 'flex'; el.className = 'stage active'; currentStage = i; scrollToBottom(); }
        };

        const complete = (i) => {
          if (i >= stages.length) return;
          const el = document.getElementById('stg-' + stages[i].id);
          if (el) {
            el.className = 'stage done';
            el.querySelector('.stage-icon').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          }
        };

        const updateTime = () => {
          const s = ((Date.now() - stageStart) / 1000).toFixed(1);
          const el = document.getElementById('tm-' + stages[currentStage].id);
          if (el) el.textContent = s + 's';
        };

        const clearStages = () => {
          stageTimers.forEach(t => clearTimeout(t));
          stageTimers = [];
          if (elapsedTimer) { clearInterval(elapsedTimer); elapsedTimer = null; }
          stages.forEach((s, i) => {
            complete(i);
            const el = document.getElementById('stg-' + s.id);
            if (el) el.style.display = 'flex';
          });
        };

        // ═══════════════════════════════════════════════
        // SEND MESSAGE
        // ═══════════════════════════════════════════════

        const sendMessage = async (text) => {
          if (isProcessing || !text) return;

          dockInput();
          isProcessing = true;

          addMessage('user', text);
          conversationHistory.push({ role: 'user', content: text });

          showThinking();
          updateSendBtn();

          try {
            const res = await fetch(PROXY_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: text,
                conversationHistory: conversationHistory,
                lastFormValues: {},
                enableCaching: true
              }),
            });

            if (!res.ok) throw new Error('Request failed (' + res.status + ')');

            const data = await res.json();
            const responseText = data.response || data.message || JSON.stringify(data);

            conversationHistory.push({ role: 'assistant', content: responseText });
            addMessage('assistant', responseText);

          } catch (err) {
            addMessage('assistant', 'Something went wrong. Please try again.', true);
          }

          isProcessing = false;
          updateSendBtn();
          inputField.focus();
        };

        // ═══════════════════════════════════════════════
        // EVENT LISTENERS
        // ═══════════════════════════════════════════════

        inputField.addEventListener('input', () => {
          autoGrow(inputField);
          updateSendBtn();
        });

        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) inputForm.requestSubmit();
          }
          if (e.key === 'Escape') {
            inputField.value = '';
            autoGrow(inputField);
            updateSendBtn();
          }
        });

        inputForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const text = inputField.value.trim();
          if (!text) return;
          inputField.value = '';
          inputField.style.height = 'auto';
          updateSendBtn();
          sendMessage(text);
        });

        // Quick prompts
        document.querySelectorAll('.quick-prompt').forEach(btn => {
          btn.addEventListener('click', () => {
            const prompt = btn.getAttribute('data-prompt');
            if (prompt) sendMessage(prompt);
          });
        });

        // Prevent scroll conflicts
        messages.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        }, { passive: true });

        // Adjust for virtual keyboard
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', () => {
            if (chatStarted) scrollToBottom();
          });
        }

        // ═══════════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════════

        updateSendBtn();

        // Apply WHITE_LABEL
        if (typeof WHITE_LABEL !== 'undefined') {
          const wl = WHITE_LABEL;

          // Header brand
          document.getElementById('headerName').textContent = wl.brandPart1;
          document.getElementById('headerSuffix').textContent = wl.brandPart2;

          // Welcome title
          document.getElementById('welcomeTitle').textContent = wl.brandPart1 + ' ' + wl.brandPart2;

          // Input placeholder
          inputField.placeholder = wl.placeholder;

          // Footer (docked)
          document.getElementById('ftContact').innerHTML = wl.taglineLeft;
          const ftLink = document.getElementById('ftLink');
          ftLink.href = wl.taglineLink;
          ftLink.textContent = wl.taglineRight + ' \u203A';
          document.getElementById('ftCopy').textContent = wl.copyright;
          document.getElementById('ftDisclaimer').textContent = wl.disclaimer;

          // Centered footer
          document.getElementById('cfContact').innerHTML = wl.taglineLeft;
          const cfLink = document.getElementById('cfLink');
          cfLink.href = wl.taglineLink;
          cfLink.textContent = wl.taglineRight + ' \u203A';
          document.getElementById('cfCopy').textContent = wl.copyright;
          document.getElementById('cfDisclaimer').textContent = wl.disclaimer;

          // CSS custom props for accent
          document.documentElement.style.setProperty('--purple-600', wl.brandColor || '#9333ea');
          document.documentElement.style.setProperty('--purple-700', wl.brandColor || '#7c3aed');
        }

        // Focus only on desktop (prevents keyboard popup on mobile)
        if (window.innerWidth > 768) {
          inputField.focus();
        }

        // Notify parent frame
        try {
          if (window.parent !== window) {
            window.parent.postMessage({ type: 'g1-widget-ready' }, '*');
          }
        } catch (e) {}

      })();
    </script>
  </body>
</html>
