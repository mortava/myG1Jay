<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
    <meta name="robots" content="noindex, nofollow" />

    <!--
    ╔══════════════════════════════════════════════════════════════╗
    ║              WHITE LABEL CONFIG - EDIT BELOW                ║
    ║  Change these values for each new client deployment.        ║
    ╚══════════════════════════════════════════════════════════════╝
    -->
    <script>
      const WHITE_LABEL = {
        // Brand name (split into two parts for two-tone logo)
        brandPart1:     "Carol",              // Bold magenta/pink
        brandPart2:     "AI Assistant",       // Lighter purple

        // Page title (browser tab)
        pageTitle:      "Carol AI Assistant",

        // Tagline below the chat input
        taglineLeft:    "Need Help? Jay Beach | 901.289.0344",
        taglineRight:   "BUILT BY G1 GROUP | Portal Access",
        taglineLink:    "https://g1wins.com",
        copyright:      "\u00A9 OpenBroker Labs",

        // Disclaimer
        disclaimer:     "This AI Tool is not a part of the above mentioned mortgage professional's Company, nothing provided by this tool is any type of commitment to lend or arrange any type of loan. AI can make mistakes. Check important info. Intended for information use only.",

        // Input placeholder
        placeholder:    "Ask me anything about your mortgage...",

        // Accent colors
        accentColor:    "#C084FC",        // Light purple for brandPart2
        brandColor:     "#D946EF",        // Magenta/fuchsia for brandPart1
      };

      document.title = WHITE_LABEL.pageTitle;
    </script>

    <title>Mortgage AI Assistant</title>

    <style>
      :root {
        --bg-page: #F3F4F6;
        --bg-primary: #FFFFFF;
        --bg-assistant: #F3F4F6;
        --bg-user: #DBEAFE;
        --text-primary: #111827;
        --text-secondary: #6B7280;
        --text-inverse: #FFFFFF;
        --border: #E5E7EB;
        --accent: #3B82F6;
        --send-btn: #C9CDD3;
        --send-btn-hover: #3B82F6;
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 15px;
        color: var(--text-primary);
        background: var(--bg-page);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ── Widget Shell ── */
      .chat-widget {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        height: 100vh;
        width: 100%;
        background: var(--bg-page);
        position: relative;
      }

      /* ── Messages Container ── */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .messages-container::-webkit-scrollbar {
        width: 10px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: #B0B0B0;
        border-radius: 5px;
      }

      .messages-container::-webkit-scrollbar-thumb:hover {
        background: #909090;
      }

      /* ── Welcome Message ── */
      .welcome-prompt {
        display: none;
      }

      .welcome-prompt.hidden {
        display: none;
      }

      /* ── Message Bubbles ── */
      .message-row {
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
      }

      .message-row.assistant {
        align-items: flex-start;
      }

      .message-row.user {
        align-items: flex-end;
      }

      .message-bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.6;
        font-size: 14px;
      }

      .message-row.assistant .message-bubble {
        background: #FFFFFF;
        color: #000000;
        border-bottom-left-radius: 4px;
        border: 1px solid #E5E7EB;
      }

      .message-row.user .message-bubble {
        background: var(--bg-user);
        color: var(--text-primary);
        border-bottom-right-radius: 4px;
      }

      /* Static disclaimer under input — hidden, replaced by brand footer */
      .input-disclaimer {
        display: none;
      }

      /* ── Rich Text in Assistant Bubbles ── */
      .message-bubble h3,
      .message-bubble h4 {
        margin: 0 0 8px 0;
        font-weight: 600;
      }
      .message-bubble h3 { font-size: 15px; }
      .message-bubble h4 { font-size: 14px; }

      .message-bubble p {
        margin: 0 0 8px 0;
      }
      .message-bubble p:last-child {
        margin-bottom: 0;
      }

      .message-bubble ul,
      .message-bubble ol {
        margin: 8px 0;
        padding-left: 20px;
      }
      .message-bubble li {
        margin: 4px 0;
      }

      .message-bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 12px;
      }
      .message-row.assistant .message-bubble th,
      .message-row.assistant .message-bubble td {
        border: 1px solid var(--border);
        padding: 6px 8px;
        text-align: left;
      }
      .message-row.assistant .message-bubble th {
        background: #F3F4F6;
        font-weight: 600;
      }
      .message-row.assistant .message-bubble tr:nth-child(even) td {
        background: #F9FAFB;
      }

      .message-bubble strong {
        font-weight: 600;
      }

      .message-bubble a {
        color: inherit;
        text-decoration: underline;
      }

      /* ── Thinking / Loading ── */
      .thinking-row {
        display: flex;
        align-items: flex-start;
        animation: slideIn 0.3s ease;
      }

      .thinking-bubble {
        background: var(--bg-assistant);
        color: var(--text-primary);
        padding: 14px 18px;
        border-radius: var(--radius-md);
        border-bottom-left-radius: 4px;
        max-width: 85%;
      }

      .thinking-dots {
        display: flex;
        align-items: center;
        gap: 5px;
        height: 20px;
      }

      .thinking-dots span {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        animation: dotPulse 1.4s ease-in-out infinite;
      }

      .thinking-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .thinking-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotPulse {
        0%, 80%, 100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* ── Centered input state (before chat starts) ── */
      .chat-widget.centered .messages-container {
        display: flex;
        flex: 1;
      }

      .chat-widget.centered .input-zone {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 48px);
        max-width: 700px;
      }

      .chat-widget.centered .input-container {
        border-top: none;
      }

      /* ── Docked input state (after chat starts) ── */
      .chat-widget:not(.centered) .input-zone {
        flex-shrink: 0;
        transition: all 0.3s ease;
      }

      /* ── Input Zone ── */
      .input-container {
        display: flex;
        align-items: stretch;
        padding: 0;
        border-top: none;
        background: transparent;
        flex-shrink: 0;
      }

      .chat-widget:not(.centered) .input-container {
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
      }

      /* ── Thinking Stages ── */
      .thinking-stages {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 4px 0;
      }

      .thinking-stage {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: #F3F4F6;
        border-radius: var(--radius-sm);
        font-size: 13px;
        color: var(--text-secondary);
        opacity: 0;
        transform: translateX(-8px);
        animation: stageIn 0.3s ease forwards;
      }

      @keyframes stageIn {
        to { opacity: 1; transform: translateX(0); }
      }

      .thinking-stage.active {
        color: var(--accent);
        background: rgba(59, 130, 246, 0.08);
      }

      .thinking-stage.complete {
        color: #10B981;
        background: rgba(16, 185, 129, 0.08);
      }

      .thinking-stage .stage-icon {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thinking-stage .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .thinking-stage .check-icon {
        color: #10B981;
      }

      .thinking-stage .stage-text {
        flex: 1;
        font-weight: 500;
      }

      .thinking-stage .stage-time {
        font-size: 11px;
        opacity: 0.7;
      }

      .input-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 14px 16px 10px;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-height: 80px;
      }

      .input-wrapper:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .input-field {
        flex: 1;
        border: none;
        background: transparent;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: 16px;
        line-height: 1.5;
        color: var(--text-primary);
        min-height: 28px;
        max-height: 160px;
        padding: 0;
        overflow-y: auto;
        -webkit-appearance: none;
        appearance: none;
      }

      .input-field::placeholder {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .input-bottom-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
      }

      .attach-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, color 0.2s;
        -webkit-tap-highlight-color: transparent;
      }

      .attach-btn:hover {
        background: var(--bg-assistant);
        color: var(--text-primary);
      }

      .send-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: var(--send-btn);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, transform 0.15s;
        flex-shrink: 0;
        -webkit-tap-highlight-color: transparent;
      }

      .send-btn:hover:not(:disabled) {
        background: var(--send-btn-hover);
      }

      .send-btn:active:not(:disabled) {
        transform: scale(0.92);
      }

      .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .send-btn:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .send-btn svg {
        width: 20px;
        height: 20px;
      }

      /* ── Error message ── */
      .error-bubble {
        background: #FEF2F2 !important;
        color: #991B1B !important;
        border: 1px solid #FECACA;
      }

      /* ── Animations ── */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ── Chat Action Buttons (copy + share) ── */
      .chat-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 6px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .message-row.assistant:hover .chat-actions,
      .message-row.assistant .chat-actions.visible {
        opacity: 1;
      }

      /* Always show on touch devices */
      @media (hover: none) {
        .chat-actions {
          opacity: 1;
        }
      }

      .chat-action-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s, color 0.15s;
        -webkit-tap-highlight-color: transparent;
        padding: 0;
      }

      .chat-action-btn:hover {
        background: var(--bg-assistant);
        color: var(--text-primary);
      }

      .chat-action-btn.copied {
        color: #10B981;
      }

      .chat-action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* ── Mobile-first: no constraints ── */
      .messages-container {
        padding: 12px 10px;
        gap: 6px;
      }

      .message-bubble {
        max-width: 90%;
        font-size: 14px;
        padding: 10px 14px;
      }

      .input-field {
        font-size: 16px; /* prevents iOS zoom */
      }

      .input-wrapper {
        min-height: 70px;
        padding: 12px 14px 8px;
      }

      /* ── Tablet+ ── */
      @media (min-width: 601px) {
        .messages-container {
          padding: 16px 12px;
          gap: 8px;
        }

        .message-bubble {
          max-width: 85%;
          font-size: 15px;
          padding: 12px 16px;
        }

        .input-wrapper {
          min-height: 80px;
          padding: 14px 16px 10px;
        }
      }

      /* ── Safe area for notched devices ── */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .chat-widget:not(.centered) .input-zone {
          padding-bottom: env(safe-area-inset-bottom);
        }
      }

      /* Mobile: full-width centered input zone */
      @media (max-width: 600px) {
        .chat-widget.centered .input-zone {
          width: calc(100% - 24px);
          max-width: none;
        }

        .brand-tagline {
          flex-direction: column;
          gap: 2px;
        }
      }

      /* ── Reduced motion ── */
      @media (prefers-reduced-motion: reduce) {
        .message-row,
        .thinking-row {
          animation: none;
        }

        .thinking-dots span {
          animation: none;
          opacity: 0.5;
        }

        .messages-container {
          scroll-behavior: auto;
        }
      }

      /* ── Focus visible for keyboard users ── */
      .input-wrapper:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }

      /* ── White Label: Brand Logo ── */
      .brand-header {
        padding: 16px 16px 8px;
        flex-shrink: 0;
      }

      .brand-logo {
        font-size: 28px;
        font-weight: 800;
        line-height: 1.2;
        letter-spacing: -0.5px;
      }

      .brand-logo .part1 {
        color: var(--brand-color, #1F2937);
      }

      .brand-logo .part2 {
        color: var(--accent-brand, #9CA3AF);
      }

      /* ── Gradient top bar ── */
      .top-bar {
        height: 4px;
        background: linear-gradient(90deg, #EC4899, #D946EF, #A855F7);
        flex-shrink: 0;
      }

      /* ── White Label: Tagline + Disclaimer (inside input-zone) ── */
      .brand-tagline-block {
        padding: 12px 4px 0;
      }

      .brand-tagline {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 4px 12px;
        margin-bottom: 8px;
      }

      .brand-tagline .built-for {
        font-size: 15px;
        color: var(--text-secondary);
        font-weight: 400;
      }

      .brand-tagline .built-for .name {
        color: var(--text-primary);
        font-weight: 700;
      }

      .brand-tagline .visit-link {
        font-size: 14px;
        color: var(--text-secondary);
        text-decoration: none;
        white-space: nowrap;
      }

      .brand-tagline .visit-link:hover {
        color: var(--text-primary);
      }

      .brand-copyright {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      .brand-disclaimer {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      /* ── White Label: Brand Footer (docked mode) ── */
      .brand-footer {
        padding: 8px 16px 12px;
        flex-shrink: 0;
        background: var(--bg-page);
      }

      /* Hide pinned header in centered mode — show inline logo above input instead */
      .chat-widget.centered .brand-header {
        display: none;
      }

      .chat-widget.centered .brand-header-inline {
        display: block;
        margin-bottom: 8px;
      }

      .chat-widget:not(.centered) .brand-header-inline {
        display: none;
      }

      /* In centered mode, hide the separate footer — tagline is in the input zone */
      .chat-widget.centered .brand-footer {
        display: none;
      }

      /* In docked (chat active) mode, hide the tagline inside input-zone — use footer instead */
      .chat-widget:not(.centered) .brand-tagline-block {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="chat-widget centered" id="chatWidget" role="main" aria-label="Mortgage Assistant Chat">

      <!-- Gradient top bar -->
      <div class="top-bar"></div>

      <!-- Brand Header (visible after chat starts, pinned to top) -->
      <div class="brand-header" id="brandHeader">
        <div class="brand-logo">
          <span class="part1" id="brandPart1"></span> <span class="part2" id="brandPart2"></span>
        </div>
      </div>

      <!-- Messages Area -->
      <div class="messages-container" id="messagesContainer" role="log" aria-live="polite" aria-label="Chat messages">
        <div class="welcome-prompt" id="welcomePrompt">
          <p id="welcomeText"></p>
        </div>
      </div>

      <!-- Input Zone (floats center initially, docks to bottom on chat start) -->
      <div class="input-zone" id="inputZone">
        <!-- Inline brand logo (visible only in centered/pre-chat state) -->
        <div class="brand-header-inline" id="brandHeaderInline">
          <div class="brand-logo">
            <span class="part1" id="brandPart1Inline"></span> <span class="part2" id="brandPart2Inline"></span>
          </div>
        </div>
        <form class="input-container" id="inputForm" autocomplete="off" role="form" aria-label="Send a message">
          <div class="input-wrapper">
            <label for="inputField" class="sr-only" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">Type your message</label>
            <textarea
              id="inputField"
              class="input-field"
              rows="2"
              placeholder=""
              aria-label="Message input"
              autocomplete="off"
              enterkeyhint="send"
            ></textarea>
            <div class="input-bottom-row">
              <button type="button" class="attach-btn" id="attachBtn" aria-label="Upload file">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <button type="submit" class="send-btn" id="sendBtn" disabled aria-label="Send message">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </form>
        <!-- Tagline + Disclaimer (inside input zone so it centers with input) -->
        <div class="brand-tagline-block" id="brandTaglineBlock">
          <div class="brand-tagline">
            <div>
              <span class="built-for" id="builtFor"></span>
              <div class="brand-copyright" id="brandCopyright"></div>
            </div>
            <a class="visit-link" id="visitLink" href="#" target="_blank" rel="noopener"></a>
          </div>
          <div class="brand-disclaimer" id="brandDisclaimer"></div>
        </div>
      </div>

      <!-- Brand Footer: Tagline + Disclaimer (visible in docked/chat mode) -->
      <div class="brand-footer" id="brandFooter">
        <div class="brand-tagline">
          <div>
            <span class="built-for" id="builtForDocked"></span>
            <div class="brand-copyright" id="brandCopyrightDocked"></div>
          </div>
          <a class="visit-link" id="visitLinkDocked" href="#" target="_blank" rel="noopener"></a>
        </div>
        <div class="brand-disclaimer" id="brandDisclaimerDocked"></div>
      </div>
    </div>

    <script>
      (function() {
        'use strict';

        const PROXY_URL = '/api/chat';

        const chatWidget = document.getElementById('chatWidget');
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomePrompt = document.getElementById('welcomePrompt');
        const inputForm = document.getElementById('inputForm');
        const inputField = document.getElementById('inputField');
        const sendBtn = document.getElementById('sendBtn');

        let conversationHistory = [];
        let isProcessing = false;
        let chatStarted = false;

        // ── Thinking stages config ──
        const thinkingStages = [
          { id: 'analyze', text: 'Analyzing your question' },
          { id: 'search', text: 'Searching program matrices' },
          { id: 'calculate', text: 'Calculating eligibility' },
          { id: 'format', text: 'Preparing response' }
        ];
        let stageTimers = [];
        let stageStartTime = 0;
        let currentStageIndex = 0;
        let elapsedInterval = null;

        // ── Auto-grow textarea ──
        const autoGrow = (el) => {
          el.style.height = '44px';
          el.style.height = Math.min(el.scrollHeight, 160) + 'px';
        };

        // ── Helpers ──

        const scrollToBottom = () => {
          requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          });
        };

        const scrollToElement = (element) => {
          requestAnimationFrame(() => {
            if (element) {
              element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        };

        const dockInput = () => {
          if (!chatStarted) {
            chatStarted = true;
            chatWidget.classList.remove('centered');
          }
          if (welcomePrompt && !welcomePrompt.classList.contains('hidden')) {
            welcomePrompt.classList.add('hidden');
          }
        };

        const updateSendBtn = () => {
          sendBtn.disabled = !inputField.value.trim() || isProcessing;
        };

        // ── Markdown Formatting ──

        const formatCellContent = (text) => {
          return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };

        const convertMarkdownTables = (text) => {
          const tableRegex = /\|(.+)\|\n\|[-|\s]+\|\n((?:\|.+\|\n?)+)/g;
          return text.replace(tableRegex, (match, headerRow, bodyRows) => {
            const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
            const rows = bodyRows.trim().split('\n');
            let table = '<table><thead><tr>';
            headers.forEach(h => { table += '<th>' + formatCellContent(h) + '</th>'; });
            table += '</tr></thead><tbody>';
            rows.forEach(row => {
              const cells = row.split('|').map(c => c.trim()).filter(c => c);
              table += '<tr>';
              cells.forEach(c => { table += '<td>' + formatCellContent(c) + '</td>'; });
              table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
          });
        };

        const formatResponse = (text) => {
          if (!text) return 'No response received.';
          let f = text;

          // Tables first
          f = convertMarkdownTables(f);

          // Headers
          f = f.replace(/^### (.*$)/gm, '<h4>$1</h4>');
          f = f.replace(/^## (.*$)/gm, '<h3>$1</h3>');

          // Bold & italic
          f = f.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          f = f.replace(/\*(.*?)\*/g, '<em>$1</em>');

          // Bullets
          f = f.replace(/^- (.*$)/gm, '<li>$1</li>');
          f = f.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

          // Numbered lists
          f = f.replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>');

          // Line breaks
          f = f.replace(/\n\n/g, '</p><p>');
          f = f.replace(/\n/g, '<br>');

          if (!f.startsWith('<')) {
            f = '<p>' + f + '</p>';
          }
          return f;
        };

        // ── Message Rendering ──

        // ── Copy / Share SVG icons ──
        const COPY_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
        const CHECK_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        const SHARE_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>';

        const copyText = (text, btn) => {
          navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = CHECK_ICON;
            btn.classList.add('copied');
            setTimeout(() => { btn.innerHTML = COPY_ICON; btn.classList.remove('copied'); }, 1500);
          });
        };

        const shareText = (text) => {
          if (navigator.share) {
            navigator.share({ text: text }).catch(() => {});
          } else {
            navigator.clipboard.writeText(text).then(() => {
              // Fallback: copy to clipboard
            });
          }
        };

        const addMessage = (role, text, isError) => {
          // Clear thinking stages and remove indicator
          const thinkingEl = document.getElementById('thinkingIndicator');
          if (thinkingEl) {
            clearThinkingStages();
            setTimeout(() => thinkingEl.remove(), 300);
          }

          const row = document.createElement('div');
          row.className = 'message-row ' + role;
          row.setAttribute('role', 'article');
          row.setAttribute('aria-label', role === 'user' ? 'You said' : 'Assistant said');

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble' + (isError ? ' error-bubble' : '');

          if (role === 'assistant') {
            bubble.innerHTML = formatResponse(text);
          } else {
            bubble.textContent = text;
          }

          row.appendChild(bubble);

          // Add copy + share action buttons for assistant messages
          if (role === 'assistant' && !isError) {
            const actions = document.createElement('div');
            actions.className = 'chat-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'chat-action-btn';
            copyBtn.setAttribute('aria-label', 'Copy response');
            copyBtn.innerHTML = COPY_ICON;
            copyBtn.addEventListener('click', () => copyText(text, copyBtn));

            const shareBtn = document.createElement('button');
            shareBtn.className = 'chat-action-btn';
            shareBtn.setAttribute('aria-label', 'Share response');
            shareBtn.innerHTML = SHARE_ICON;
            shareBtn.addEventListener('click', () => shareText(text));

            actions.appendChild(copyBtn);
            actions.appendChild(shareBtn);
            row.appendChild(actions);
          }

          messagesContainer.appendChild(row);

          // For user messages, scroll to bottom to show what they typed
          // For assistant messages, scroll to top of the response so user reads from the beginning
          if (role === 'user') {
            scrollToBottom();
          } else {
            scrollToElement(row);
          }
        };

        const showThinking = () => {
          const row = document.createElement('div');
          row.className = 'message-row assistant';
          row.id = 'thinkingIndicator';
          row.setAttribute('role', 'status');
          row.setAttribute('aria-label', 'Assistant is thinking');

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';

          let html = '<div class="thinking-stages">';
          thinkingStages.forEach(stage => {
            html += '<div class="thinking-stage" id="stage-' + stage.id + '" style="display:none;">' +
              '<div class="stage-icon"><div class="spinner"></div></div>' +
              '<span class="stage-text">' + stage.text + '</span>' +
              '<span class="stage-time" id="time-' + stage.id + '"></span>' +
              '</div>';
          });
          html += '</div>';
          bubble.innerHTML = html;

          row.appendChild(bubble);
          messagesContainer.appendChild(row);
          scrollToBottom();
          startThinkingStages();
        };

        const startThinkingStages = () => {
          stageStartTime = Date.now();
          currentStageIndex = 0;
          stageTimers = [];
          activateStage(0);
          stageTimers.push(setTimeout(() => { completeStage(0); activateStage(1); }, 600));
          stageTimers.push(setTimeout(() => { completeStage(1); activateStage(2); }, 1500));
          stageTimers.push(setTimeout(() => { completeStage(2); activateStage(3); }, 2800));
          elapsedInterval = setInterval(updateElapsedTime, 100);
        };

        const activateStage = (index) => {
          if (index >= thinkingStages.length) return;
          const stage = document.getElementById('stage-' + thinkingStages[index].id);
          if (stage) {
            stage.style.display = 'flex';
            stage.className = 'thinking-stage active';
            currentStageIndex = index;
            scrollToBottom();
          }
        };

        const completeStage = (index) => {
          if (index >= thinkingStages.length) return;
          const stage = document.getElementById('stage-' + thinkingStages[index].id);
          if (stage) {
            stage.className = 'thinking-stage complete';
            stage.querySelector('.stage-icon').innerHTML = '<svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          }
        };

        const updateElapsedTime = () => {
          const elapsed = ((Date.now() - stageStartTime) / 1000).toFixed(1);
          const timeEl = document.getElementById('time-' + thinkingStages[currentStageIndex].id);
          if (timeEl) timeEl.textContent = elapsed + 's';
        };

        const clearThinkingStages = () => {
          stageTimers.forEach(timer => clearTimeout(timer));
          stageTimers = [];
          if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
          thinkingStages.forEach((stage, i) => {
            completeStage(i);
            const el = document.getElementById('stage-' + stage.id);
            if (el) el.style.display = 'flex';
          });
        };

        // ── Send Message ──

        const sendMessage = async (text) => {
          if (isProcessing || !text) return;

          dockInput();
          isProcessing = true;

          addMessage('user', text);
          conversationHistory.push({ role: 'user', content: text });

          showThinking();
          updateSendBtn();

          try {
            const res = await fetch(PROXY_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: text,
                conversationHistory: conversationHistory,
                lastFormValues: {},
                enableCaching: true
              }),
            });

            if (!res.ok) throw new Error('Request failed (' + res.status + ')');

            const data = await res.json();
            const responseText = data.response || data.message || JSON.stringify(data);

            conversationHistory.push({ role: 'assistant', content: responseText });
            addMessage('assistant', responseText);

          } catch (err) {
            addMessage('assistant', 'Something went wrong. Please try again.', true);
          }

          isProcessing = false;
          updateSendBtn();
          inputField.focus();
        };

        // ── Event Listeners ──

        inputField.addEventListener('input', () => {
          autoGrow(inputField);
          updateSendBtn();
        });

        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) inputForm.requestSubmit();
          }
        });

        // Escape to clear input
        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            inputField.value = '';
            updateSendBtn();
          }
        });

        inputForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const text = inputField.value.trim();
          if (!text) return;
          inputField.value = '';
          inputField.style.height = '44px';
          updateSendBtn();
          sendMessage(text);
        });

        // ── Prevent parent page scroll conflicts ──
        messagesContainer.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        }, { passive: true });

        // ── Adjust for mobile keyboard ──
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', () => {
            scrollToBottom();
          });
        }

        // ── Init ──
        updateSendBtn();
        inputField.focus();

        // ── Apply WHITE_LABEL config to DOM ──
        if (typeof WHITE_LABEL !== 'undefined') {
          const wl = WHITE_LABEL;

          // Brand logo (both pinned header and inline centered version)
          document.getElementById('brandPart1').textContent = wl.brandPart1;
          document.getElementById('brandPart2').textContent = wl.brandPart2;
          document.getElementById('brandPart1Inline').textContent = wl.brandPart1;
          document.getElementById('brandPart2Inline').textContent = wl.brandPart2;

          // Brand colors
          document.documentElement.style.setProperty('--accent-brand', wl.accentColor);
          if (wl.brandColor) {
            document.documentElement.style.setProperty('--brand-color', wl.brandColor);
          }

          // Input placeholder
          inputField.placeholder = wl.placeholder;

          // Tagline — left side text
          const leftText = wl.taglineLeft || ('AI Assistant to ' + (wl.taglineName || ''));
          document.getElementById('builtFor').textContent = leftText;
          document.getElementById('builtForDocked').textContent = leftText;

          // Tagline — right side link with arrow
          const rightText = (wl.taglineRight || wl.taglineLinkText || '') + ' \u203A';
          const setLink = (el) => { el.href = wl.taglineLink; el.textContent = rightText; };
          setLink(document.getElementById('visitLink'));
          setLink(document.getElementById('visitLinkDocked'));

          // Copyright line
          if (wl.copyright) {
            document.getElementById('brandCopyright').textContent = wl.copyright;
            document.getElementById('brandCopyrightDocked').textContent = wl.copyright;
          }

          // Disclaimer
          document.getElementById('brandDisclaimer').textContent = wl.disclaimer;
          document.getElementById('brandDisclaimerDocked').textContent = wl.disclaimer;
        }

        // Notify parent frame the widget is ready
        try {
          if (window.parent !== window) {
            window.parent.postMessage({ type: 'g1-widget-ready' }, '*');
          }
        } catch (e) { /* cross-origin, ignore */ }

      })();
    </script>
  </body>
</html>
